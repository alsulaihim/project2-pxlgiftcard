<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Confirmation Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .user-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            position: relative;
        }
        .sent {
            background: #dcf8c6;
            text-align: right;
        }
        .received {
            background: #e8e8e8;
            text-align: left;
        }
        .status {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .check-marks {
            display: inline-block;
            margin-left: 5px;
        }
        .single-check::after { content: 'âœ“'; color: gray; }
        .double-check::after { content: 'âœ“âœ“'; color: gray; }
        .double-check-blue::after { content: 'âœ“âœ“'; color: #25D366; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Delivery Confirmation Test</h1>
    
    <div class="container">
        <div class="user-panel">
            <h2>User 1 (Sender)</h2>
            <button onclick="sendMessageUser1()">Send Message</button>
            <div id="messages1"></div>
            <div class="log" id="log1"></div>
        </div>
        
        <div class="user-panel">
            <h2>User 2 (Receiver)</h2>
            <button onclick="sendMessageUser2()">Send Message</button>
            <div id="messages2"></div>
            <div class="log" id="log2"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket1, socket2;
        let messages1 = [], messages2 = [];
        let messageCounter = 0;
        
        function log(userId, message) {
            const logEl = document.getElementById(`log${userId}`);
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML = `[${time}] ${message}<br>` + logEl.innerHTML;
        }
        
        function updateMessages(userId) {
            const messagesEl = document.getElementById(`messages${userId}`);
            const messages = userId === 1 ? messages1 : messages2;
            const currentUserId = userId === 1 ? 'user1' : 'user2';
            
            messagesEl.innerHTML = messages.map(msg => {
                const isSent = msg.senderId === currentUserId;
                let statusIcon = '';
                
                if (isSent) {
                    if (msg.read && msg.read.length > 0) {
                        statusIcon = '<span class="check-marks double-check-blue"></span>';
                    } else if (msg.delivered && msg.delivered.length > 0) {
                        statusIcon = '<span class="check-marks double-check"></span>';
                    } else {
                        statusIcon = '<span class="check-marks single-check"></span>';
                    }
                }
                
                return `
                    <div class="message ${isSent ? 'sent' : 'received'}">
                        ${msg.text}
                        <div class="status">
                            ${msg.timestamp} ${statusIcon}
                            ${msg.delivered ? `<br>Delivered to: ${msg.delivered.join(', ')}` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function connectUser1() {
            socket1 = io('http://localhost:3009', {
                auth: {
                    token: 'test-token-user1'
                }
            });
            
            socket1.on('connect', () => {
                log(1, 'âœ… Connected');
                socket1.emit('conversation:join', 'direct_user1_user2');
            });
            
            socket1.on('message:new', (message) => {
                log(1, `ðŸ“¨ New message: ${message.text || message.senderText}`);
                messages1.push(message);
                updateMessages(1);
                
                // Send delivery confirmation if not our message
                if (message.senderId !== 'user1') {
                    log(1, `ðŸ“® Sending delivery confirmation for ${message.id}`);
                    socket1.emit('message:delivered', {
                        conversationId: message.conversationId,
                        messageId: message.id
                    });
                }
            });
            
            socket1.on('message:delivered', (data) => {
                log(1, `âœ“âœ“ Message ${data.messageId} delivered to ${data.userId}`);
                const msg = messages1.find(m => m.id === data.messageId);
                if (msg) {
                    if (!msg.delivered) msg.delivered = [];
                    if (!msg.delivered.includes(data.userId)) {
                        msg.delivered.push(data.userId);
                    }
                    updateMessages(1);
                }
            });
            
            socket1.on('message:sent', (data) => {
                log(1, `âœ“ Message sent: ${data.messageId}`);
            });
        }
        
        function connectUser2() {
            socket2 = io('http://localhost:3009', {
                auth: {
                    token: 'test-token-user2'
                }
            });
            
            socket2.on('connect', () => {
                log(2, 'âœ… Connected');
                socket2.emit('conversation:join', 'direct_user1_user2');
            });
            
            socket2.on('message:new', (message) => {
                log(2, `ðŸ“¨ New message: ${message.text || message.senderText}`);
                messages2.push(message);
                updateMessages(2);
                
                // Send delivery confirmation if not our message
                if (message.senderId !== 'user2') {
                    log(2, `ðŸ“® Sending delivery confirmation for ${message.id}`);
                    socket2.emit('message:delivered', {
                        conversationId: message.conversationId,
                        messageId: message.id
                    });
                }
            });
            
            socket2.on('message:delivered', (data) => {
                log(2, `âœ“âœ“ Message ${data.messageId} delivered to ${data.userId}`);
                const msg = messages2.find(m => m.id === data.messageId);
                if (msg) {
                    if (!msg.delivered) msg.delivered = [];
                    if (!msg.delivered.includes(data.userId)) {
                        msg.delivered.push(data.userId);
                    }
                    updateMessages(2);
                }
            });
            
            socket2.on('message:sent', (data) => {
                log(2, `âœ“ Message sent: ${data.messageId}`);
            });
        }
        
        function sendMessageUser1() {
            const text = `Message ${++messageCounter} from User 1`;
            socket1.emit('message:send', {
                conversationId: 'direct_user1_user2',
                type: 'text',
                text: text,
                senderText: text
            });
            log(1, `ðŸ“¤ Sending: ${text}`);
        }
        
        function sendMessageUser2() {
            const text = `Message ${++messageCounter} from User 2`;
            socket2.emit('message:send', {
                conversationId: 'direct_user1_user2',
                type: 'text',
                text: text,
                senderText: text
            });
            log(2, `ðŸ“¤ Sending: ${text}`);
        }
        
        // Initialize connections
        connectUser1();
        connectUser2();
    </script>
</body>
</html>