<!DOCTYPE html>
<html>
<head>
  <title>Chat Test - Normalized Conversation</title>
  <style>
    body { font-family: Arial; margin: 20px; display: flex; gap: 20px; }
    .window { border: 2px solid #ccc; padding: 15px; width: 45%; }
    .messages { height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin: 10px 0; }
    .message { padding: 5px; margin: 5px 0; border-radius: 5px; }
    .sent { background: #e3f2fd; text-align: right; }
    .received { background: #f5f5f5; }
    button { padding: 10px; margin: 5px; cursor: pointer; }
    input { padding: 8px; width: 70%; }
    .status { color: green; font-weight: bold; margin: 10px 0; }
    .error { color: red; }
    .info { background: #fffbcc; padding: 10px; margin: 10px 0; border-radius: 5px; }
  </style>
</head>
<body>
  <div class="window">
    <h2>User 1 Window</h2>
    <div class="status" id="status1">Disconnected</div>
    <div class="info" id="info1">Waiting...</div>
    <div class="messages" id="messages1"></div>
    <input type="text" id="input1" placeholder="Type message..." />
    <button onclick="sendMessage(1)">Send</button>
    <button onclick="connectUser(1)">Connect User 1</button>
  </div>

  <div class="window">
    <h2>User 2 Window</h2>
    <div class="status" id="status2">Disconnected</div>
    <div class="info" id="info2">Waiting...</div>
    <div class="messages" id="messages2"></div>
    <input type="text" id="input2" placeholder="Type message..." />
    <button onclick="sendMessage(2)">Send</button>
    <button onclick="connectUser(2)">Connect User 2</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    let socket1 = null;
    let socket2 = null;
    let user1Data = null;
    let user2Data = null;
    const CONVERSATION_ID = 'direct_test-user-1_test-user-2';

    function log(windowNum, message, isError = false) {
      const info = document.getElementById(`info${windowNum}`);
      const time = new Date().toLocaleTimeString();
      const className = isError ? 'error' : '';
      info.innerHTML = `<span class="${className}">[${time}] ${message}</span>`;
      console.log(`Window ${windowNum}: ${message}`);
    }

    function connectUser(windowNum) {
      const socket = windowNum === 1 ? socket1 : socket2;
      if (socket && socket.connected) {
        log(windowNum, 'Already connected!');
        return;
      }

      const newSocket = io('http://localhost:8080', {
        auth: { token: 'test-token-' + windowNum },
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionAttempts: 5
      });

      newSocket.on('connect', () => {
        log(windowNum, `Connected! Socket ID: ${newSocket.id}`);
        document.getElementById(`status${windowNum}`).textContent = 'Connected';
      });

      newSocket.on('auth:success', (userData) => {
        if (windowNum === 1) {
          user1Data = userData;
        } else {
          user2Data = userData;
        }
        log(windowNum, `Authenticated as ${userData.displayName} (${userData.userId}) - ${userData.tier}`);
        
        // Join the normalized conversation
        log(windowNum, `Joining conversation: ${CONVERSATION_ID}`);
        newSocket.emit('conversation:join', CONVERSATION_ID, (error, response) => {
          if (error) {
            log(windowNum, `Failed to join conversation: ${JSON.stringify(error)}`, true);
          } else {
            log(windowNum, `Successfully joined conversation: ${JSON.stringify(response)}`);
          }
        });
      });

      newSocket.on('message:new', (message) => {
        log(windowNum, `New message received from ${message.senderId}`);
        const messagesDiv = document.getElementById(`messages${windowNum}`);
        const userData = windowNum === 1 ? user1Data : user2Data;
        const isSent = userData && message.senderId === userData.userId;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
        messageDiv.innerHTML = `
          <strong>${message.sender?.displayName || message.senderId}:</strong> 
          ${message.text || message.senderText || '[encrypted]'}
          <br><small>${new Date(message.timestamp).toLocaleTimeString()}</small>
        `;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });

      newSocket.on('message:sent', (data) => {
        log(windowNum, `Message sent successfully: ${data.messageId}`);
      });

      newSocket.on('message:error', (error) => {
        log(windowNum, `Message error: ${JSON.stringify(error)}`, true);
      });

      newSocket.on('disconnect', (reason) => {
        log(windowNum, `Disconnected: ${reason}`, true);
        document.getElementById(`status${windowNum}`).textContent = 'Disconnected';
      });

      newSocket.on('error', (error) => {
        log(windowNum, `Socket error: ${error}`, true);
      });

      if (windowNum === 1) {
        socket1 = newSocket;
      } else {
        socket2 = newSocket;
      }
    }

    function sendMessage(windowNum) {
      const socket = windowNum === 1 ? socket1 : socket2;
      const userData = windowNum === 1 ? user1Data : user2Data;
      const input = document.getElementById(`input${windowNum}`);
      const text = input.value.trim();
      
      if (!text) {
        log(windowNum, 'Please enter a message', true);
        return;
      }
      
      if (!socket || !socket.connected) {
        log(windowNum, 'Not connected! Click Connect first.', true);
        return;
      }

      if (!userData) {
        log(windowNum, 'Not authenticated yet!', true);
        return;
      }

      log(windowNum, `Sending message: "${text}" to conversation: ${CONVERSATION_ID}`);
      
      socket.emit('message:send', {
        conversationId: CONVERSATION_ID,
        type: 'text',
        text: text,
        senderText: text,
        nonce: '',
        senderNonce: ''
      });
      
      input.value = '';
    }

    // Allow Enter key to send messages
    document.getElementById('input1').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage(1);
    });
    document.getElementById('input2').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage(2);
    });

    // Auto-connect both users on page load
    setTimeout(() => {
      log(1, 'Auto-connecting User 1...');
      connectUser(1);
      setTimeout(() => {
        log(2, 'Auto-connecting User 2...');
        connectUser(2);
      }, 1000);
    }, 500);
  </script>
</body>
</html>